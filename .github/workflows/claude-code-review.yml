name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    name: Automated Code Review with Claude
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze Python files
        id: analyze
        run: |
          echo "## Code Review Analysis" > review-summary.md
          echo "" >> review-summary.md
          echo "### Files Changed" >> review-summary.md
          git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | while read file; do
            echo "- $file" >> review-summary.md
          done
          echo "" >> review-summary.md

          # Check for common issues
          echo "### Automated Checks" >> review-summary.md

          # Check for large files
          git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | while read file; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              if [ $size -gt 1000000 ]; then
                echo "- âš ï¸ Large file detected: $file ($(($size / 1024))KB)" >> review-summary.md
              fi
            fi
          done

          # Check for TODO comments
          if git diff origin/${{ github.base_ref }}...${{ github.head_ref }} | grep -i "TODO\|FIXME\|HACK" > /dev/null; then
            echo "- ðŸ“ Contains TODO/FIXME/HACK comments - consider addressing before merge" >> review-summary.md
          fi

          # Check for print statements (should use logging)
          if git diff origin/${{ github.base_ref }}...${{ github.head_ref }} *.py 2>/dev/null | grep "print(" > /dev/null; then
            echo "- ðŸ’¬ Contains print() statements - consider using logging module" >> review-summary.md
          fi

          # Check for hardcoded credentials
          if git diff origin/${{ github.base_ref }}...${{ github.head_ref }} | grep -iE "password|api_key|secret|token" | grep -v "# " > /dev/null; then
            echo "- ðŸ” Potential hardcoded credentials detected - review carefully" >> review-summary.md
          fi

          cat review-summary.md

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install analysis tools
        run: |
          pip install radon mccabe pylint flake8

      - name: Calculate code complexity
        run: |
          echo "" >> review-summary.md
          echo "### Code Complexity Analysis" >> review-summary.md

          for file in $(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep "\.py$"); do
            if [ -f "$file" ]; then
              echo "" >> review-summary.md
              echo "#### $file" >> review-summary.md
              radon cc "$file" -a -s || echo "Unable to analyze $file" >> review-summary.md
            fi
          done
        continue-on-error: true

      - name: Check code style compliance
        run: |
          echo "" >> review-summary.md
          echo "### Style Compliance" >> review-summary.md

          for file in $(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep "\.py$"); do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              flake8 "$file" --max-line-length=120 >> style-issues.txt 2>&1 || true
            fi
          done

          if [ -s style-issues.txt ]; then
            echo "" >> review-summary.md
            echo "**Style issues found:**" >> review-summary.md
            echo '```' >> review-summary.md
            head -20 style-issues.txt >> review-summary.md
            echo '```' >> review-summary.md
          else
            echo "- âœ… No style issues detected" >> review-summary.md
          fi
        continue-on-error: true

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('review-summary.md', 'utf8');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `# ðŸ¤– Automated Code Review\n\n${summary}\n\n---\n*This automated review was generated by Claude Code Review workflow*`
            });

      - name: Create review summary artifact
        uses: actions/upload-artifact@v3
        with:
          name: code-review-summary
          path: review-summary.md
